<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:content="http://purl.org/rss/1.0/modules/content/">
    <channel>
        <title>Blog Blog</title>
        <link>https://lebalz.ch/</link>
        <description>Blog Blog</description>
        <lastBuildDate>Tue, 04 Jan 2022 00:00:00 GMT</lastBuildDate>
        <docs>https://validator.w3.org/feed/docs/rss2.html</docs>
        <generator>https://github.com/jpmonette/feed</generator>
        <item>
            <title><![CDATA[Speedup Build Time on Drone CI]]></title>
            <link>https://lebalz.ch/2022/01/04/cache-drone-builds</link>
            <guid>/2022/01/04/cache-drone-builds</guid>
            <pubDate>Tue, 04 Jan 2022 00:00:00 GMT</pubDate>
            <description><![CDATA[I use drone ci to build and deploy my github pages. Like that i don't have to wait for a free github runner and have a more or less constant build time. My initial Pipeline had three stages:]]></description>
            <content:encoded><![CDATA[<p>I use drone ci to build and deploy my github pages. Like that i don&#x27;t have to wait for a free github runner and have a more or less constant build time. My initial Pipeline had three stages:</p><p><img src="images/pipeline-old.png" alt="Stages"/></p><p>The <code>website</code> Stage, where the static page is compiled with Webpacker, consumed the most time. No big deal for pages with few dependencies (e.g. a clean install of Docusaurus), where a complete build takes around 1 minute on a <a href="https://www.hetzner.com/cloud">Hetzner CPX41</a> (8 VCPUs, <em>AMD EPYC 2nd</em> with 16 GB Ram). But for pages with many dependecies it took me around 8 minutes for the page to be built.</p><p>So i decided to add caching to my pipeline. Since memory on my server isn&#x27;t a problem for the moment, i&#x27;m using <em>volume cache</em> directly on my server. To do so, i configured the <code>.drony.yml</code> file with two additional stages:</p><p><img src="images/pipeline-cached.png"/></p><p>I used the <a href="https://github.com/Drillster/drone-volume-cache">drone-volume-cache</a> from <a href="https://github.com/Drillster">@drillster</a> and followed the instructions on the <a href="https://github.com/Drillster/drone-volume-cache/blob/master/DOCS.md">docs page</a>.</p><h2>Configure Drone Server</h2><p>Because my drone ci is deployed with <a href="https://lebalz/synopsis/dokku/drone-ci">Dokku</a>, the cache will be typically under <code>/var/lib/dokku/data/storage/&lt;app-name&gt;</code>.</p><pre><code class="language-bash"># create persistent directory for caching
mkdir -p /var/lib/dokku/data/storage/drone-runner/cache
</code></pre><p>The drone server itself will spawn the drone runner with a mounted volume. To do so, the repository, needs to be &quot;Trusted&quot;. This flag can only be set as an admin. So ensure you configured yourself as an admin:</p><pre><code class="language-bash"># replace foobar with your github username
dokku config:set drone-server DRONE_USER_CREATE=username:foobar,admin:true
</code></pre><p>And set the trusted flag under <code>Settings&gt;General&gt;Project Settings</code> for the repository you like to cache:</p><p><img src="images/drone-settings.png" alt="Trusted Flag"/></p><h2><code>.drone.yml</code></h2><p>Finally, add the highlighted code blocks to your drone config file.  </p><pre><code class="language-yml" metastring="{3-11,14-22,25-28}">steps:
# first step
- name: restore-cache
  image: drillster/drone-volume-cache
  volumes:
  - name: cache
    path: /cache
  settings:
    restore: true
    mount:
      - ./node_modules
# ...
# last step
- name: rebuild-cache
  image: drillster/drone-volume-cache
  volumes:
  - name: cache
    path: /cache
  settings:
    rebuild: true
    mount:
      - ./node_modules
# ...
# add volume
volumes:
  - name: cache
    host:
      path: /var/lib/dokku/data/storage/drone-runner/cache
</code></pre><details><summary>Full .drone.yml</summary><pre><code class="language-yml" metastring="title=.drone.yml" title=".drone.yml">---
kind: pipeline
type: docker
name: default

steps:
- name: restore-cache
  image: drillster/drone-volume-cache
  volumes:
  - name: cache
    path: /cache
  settings:
    restore: true
    mount:
      - ./node_modules

- name: website
  image: node:16.11.1
  commands:
  - mkdir -p $HOME/.ssh
  - ssh-keyscan -t rsa github.com &gt;&gt; $HOME/.ssh/known_hosts
  - echo &quot;$GITHUB_PRIVATE_KEY&quot; &gt; &quot;$HOME/.ssh/id_rsa&quot;
  - chmod 0600 $HOME/.ssh/id_rsa
  - yarn install --frozen-lockfile
  - npm run deploy
  environment:
    USE_SSH: true
    GIT_USER: $DRONE_COMMIT_AUTHOR
    GITHUB_PRIVATE_KEY:
      from_secret: &quot;git_deploy_private_key&quot;
  when:
    event:
      include:
      - push
      - pull_request

- name: rebuild-cache
  image: drillster/drone-volume-cache
  volumes:
  - name: cache
    path: /cache
  settings:
    rebuild: true
    mount:
      - ./node_modules

volumes:
  - name: cache
    host:
      path: /var/lib/dokku/data/storage/drone-runner/cache

trigger:
  branch:
  - main
</code></pre></details><h2>Conclusion ðŸš€</h2><p>With the added cache stages, the build time on my big page could be reduced from 8 minutes to 3:30 minutes ðŸš€. For lightweight pages it takes now around 15 seconds for a small change to be deployed, yay ðŸ¥³</p>]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Happy New Year ðŸ¥³]]></title>
            <link>https://lebalz.ch/2022/01/01/happy-new-year</link>
            <guid>/2022/01/01/happy-new-year</guid>
            <pubDate>Sat, 01 Jan 2022 00:00:00 GMT</pubDate>
            <description><![CDATA[Hangovers are perfect for config tasks. So, i set up my dev blog using Docusaurus.]]></description>
            <content:encoded><![CDATA[<p>Hangovers are perfect for config tasks. So, i set up my dev blog using <a href="https://docusaurus.io">Docusaurus</a>.</p><p><img src="/img/logo.png" alt="--width=250px"/></p>]]></content:encoded>
        </item>
    </channel>
</rss>