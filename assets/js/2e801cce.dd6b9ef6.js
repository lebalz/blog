"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[450],{6029:function(e){e.exports=JSON.parse('{"blogPosts":[{"id":"/2022/01/04/cache-drone-builds","metadata":{"permalink":"/2022/01/04/cache-drone-builds","editUrl":"https://github.com/lebalz/blog/edit/main/blog/2022-01-04-cache-drone-builds/index.md","source":"@site/blog/2022-01-04-cache-drone-builds/index.md","title":"Speedup Build Time on Drone CI","description":"I use drone ci to build and deploy my github pages. Like that i don\'t have to wait for a free github runner and have a more or less constant build time. My initial Pipeline had three stages:","date":"2022-01-04T00:00:00.000Z","formattedDate":"January 4, 2022","tags":[{"label":"drone ci","permalink":"/tags/drone-ci"},{"label":"cache","permalink":"/tags/cache"},{"label":"drone","permalink":"/tags/drone"}],"readingTime":2.42,"truncated":true,"authors":[{"name":"Balthasar Hofer","url":"https://github.com/lebalz","imageURL":"https://github.com/lebalz.png","key":"lebalz"}],"frontMatter":{"title":"Speedup Build Time on Drone CI","authors":["lebalz"],"tags":["drone ci","cache","drone"],"image":"./images/pipeline-cached.png"},"nextItem":{"title":"Happy New Year \ud83e\udd73","permalink":"/2022/01/01/happy-new-year"}},"content":"I use drone ci to build and deploy my github pages. Like that i don\'t have to wait for a free github runner and have a more or less constant build time. My initial Pipeline had three stages:\\n\\n![Stages](images/pipeline-old.png)\\n\\n\x3c!--truncate--\x3e\\n\\nThe `website` Stage, where the static page is compiled with Webpacker, consumed the most time. No big deal for pages with few dependencies (e.g. a clean install of Docusaurus), where a complete build takes around 1 minute on a [Hetzner CPX41](https://www.hetzner.com/cloud) (8 VCPUs, *AMD EPYC 2nd* with 16 GB Ram). But for pages with many dependecies it took me around 8 minutes for the page to be built.\\n\\nSo i decided to add caching to my pipeline. Since memory on my server isn\'t a problem for the moment, i\'m using *volume cache* directly on my server. To do so, i configured the `.drony.yml` file with two additional stages:\\n\\n![](images/pipeline-cached.png)\\n\\n\\nI used the [drone-volume-cache](https://github.com/Drillster/drone-volume-cache) from [@drillster](https://github.com/Drillster) and followed the instructions on the [docs page](https://github.com/Drillster/drone-volume-cache/blob/master/DOCS.md).\\n\\n## Configure Drone Server\\n\\nBecause my drone ci is deployed with [Dokku](https://lebalz/synopsis/dokku/drone-ci), the cache will be typically under `/var/lib/dokku/data/storage/<app-name>`.\\n\\n```bash\\n# create persistent directory for caching\\nmkdir -p /var/lib/dokku/data/storage/drone-runner/cache\\n```\\n\\nThe drone server itself will spawn the drone runner with a mounted volume. To do so, the repository, needs to be \\"Trusted\\". This flag can only be set as an admin. So ensure you configured yourself as an admin:\\n\\n```bash\\n# replace foobar with your github username\\ndokku config:set drone-server DRONE_USER_CREATE=username:foobar,admin:true\\n```\\n\\nAnd set the trusted flag under `Settings>General>Project Settings` for the repository you like to cache:\\n\\n![Trusted Flag](images/drone-settings.png)\\n\\n## `.drone.yml`\\n\\nFinally, add the highlighted code blocks to your drone config file.  \\n```yml {3-11,14-22,25-28}\\nsteps:\\n# first step\\n- name: restore-cache\\n  image: drillster/drone-volume-cache\\n  volumes:\\n  - name: cache\\n    path: /cache\\n  settings:\\n    restore: true\\n    mount:\\n      - ./node_modules\\n# ...\\n# last step\\n- name: rebuild-cache\\n  image: drillster/drone-volume-cache\\n  volumes:\\n  - name: cache\\n    path: /cache\\n  settings:\\n    rebuild: true\\n    mount:\\n      - ./node_modules\\n# ...\\n# add volume\\nvolumes:\\n  - name: cache\\n    host:\\n      path: /var/lib/dokku/data/storage/drone-runner/cache\\n```\\n\\n<details><summary>Full .drone.yml</summary>\\n\\n```yml title=.drone.yml\\n---\\nkind: pipeline\\ntype: docker\\nname: default\\n\\nsteps:\\n- name: restore-cache\\n  image: drillster/drone-volume-cache\\n  volumes:\\n  - name: cache\\n    path: /cache\\n  settings:\\n    restore: true\\n    mount:\\n      - ./node_modules\\n\\n- name: website\\n  image: node:16.11.1\\n  commands:\\n  - mkdir -p $HOME/.ssh\\n  - ssh-keyscan -t rsa github.com >> $HOME/.ssh/known_hosts\\n  - echo \\"$GITHUB_PRIVATE_KEY\\" > \\"$HOME/.ssh/id_rsa\\"\\n  - chmod 0600 $HOME/.ssh/id_rsa\\n  - yarn install --frozen-lockfile\\n  - npm run deploy\\n  environment:\\n    USE_SSH: true\\n    GIT_USER: $DRONE_COMMIT_AUTHOR\\n    GITHUB_PRIVATE_KEY:\\n      from_secret: \\"git_deploy_private_key\\"\\n  when:\\n    event:\\n      include:\\n      - push\\n      - pull_request\\n\\n- name: rebuild-cache\\n  image: drillster/drone-volume-cache\\n  volumes:\\n  - name: cache\\n    path: /cache\\n  settings:\\n    rebuild: true\\n    mount:\\n      - ./node_modules\\n\\nvolumes:\\n  - name: cache\\n    host:\\n      path: /var/lib/dokku/data/storage/drone-runner/cache\\n\\ntrigger:\\n  branch:\\n  - main\\n```\\n\\n</details>\\n\\n## Conclusion \ud83d\ude80\\n\\nWith the added cache stages, the build time on my big page could be reduced from 8 minutes to 3:30 minutes \ud83d\ude80. For lightweight pages it takes now around 15 seconds for a small change to be deployed, yay \ud83e\udd73"},{"id":"/2022/01/01/happy-new-year","metadata":{"permalink":"/2022/01/01/happy-new-year","editUrl":"https://github.com/lebalz/blog/edit/main/blog/2022-01-01-happy-new-year.mdx","source":"@site/blog/2022-01-01-happy-new-year.mdx","title":"Happy New Year \ud83e\udd73","description":"Hangovers are perfect for config tasks. So, i set up my dev blog using Docusaurus.","date":"2022-01-01T00:00:00.000Z","formattedDate":"January 1, 2022","tags":[{"label":"docusaurus","permalink":"/tags/docusaurus"}],"readingTime":0.085,"truncated":true,"authors":[{"name":"Balthasar Hofer","url":"https://github.com/lebalz","imageURL":"https://github.com/lebalz.png","key":"lebalz"}],"frontMatter":{"title":"Happy New Year \ud83e\udd73","authors":["lebalz"],"tags":["docusaurus"],"image":"/img/logo.png"},"prevItem":{"title":"Speedup Build Time on Drone CI","permalink":"/2022/01/04/cache-drone-builds"}},"content":"\x3c!--truncate--\x3e\\n\\nHangovers are perfect for config tasks. So, i set up my dev blog using [Docusaurus](https://docusaurus.io).\\n\\n![--width=250px](/img/logo.png)"}]}')}}]);