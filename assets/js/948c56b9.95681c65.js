"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[3193],{3905:function(e,t,n){n.d(t,{Zo:function(){return c},kt:function(){return m}});var r=n(7294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,r,o=function(e,t){if(null==e)return{};var n,r,o={},a=Object.keys(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var l=r.createContext({}),u=function(e){var t=r.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},c=function(e){var t=u(e.components);return r.createElement(l.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},p=r.forwardRef((function(e,t){var n=e.components,o=e.mdxType,a=e.originalType,l=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),p=u(n),m=o,f=p["".concat(l,".").concat(m)]||p[m]||d[m]||a;return n?r.createElement(f,i(i({ref:t},c),{},{components:n})):r.createElement(f,i({ref:t},c))}));function m(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var a=n.length,i=new Array(a);i[0]=p;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:o,i[1]=s;for(var u=2;u<a;u++)i[u]=n[u];return r.createElement.apply(null,i)}return r.createElement.apply(null,n)}p.displayName="MDXCreateElement"},7921:function(e,t,n){n.d(t,{Z:function(){return c}});var r=n(7294),o="container_AFEI",a="noMargins_PVGS";function i(e){var t,n,r="";if("string"==typeof e||"number"==typeof e)r+=e;else if("object"==typeof e)if(Array.isArray(e))for(t=0;t<e.length;t++)e[t]&&(n=i(e[t]))&&(r&&(r+=" "),r+=n);else for(t in e)e[t]&&(r&&(r+=" "),r+=t);return r}function s(){for(var e,t,n=0,r="";n<arguments.length;)(e=arguments[n++])&&(t=i(e))&&(r&&(r+=" "),r+=t);return r}var l=function(e,t){return void 0===t&&(t="px"),/^\d+(\.\d*)?$/.test(e)?""+e+t:e},u=function(e){var t={},n=Object.assign({},e.options);return n.noMargins&&delete n.noMargins,n.size&&(t.maxWidth="min(90vw, "+l(n.size)+")",t.maxHeight=l(n.size),delete n.size),n.height&&(t.maxHeight=l(n.height),t.height=l(n.height),delete n.height),n.width&&(t.maxWidth="min(90vw, "+l(n.width)+")",t.width=l(n.width),delete n.width),t=Object.assign({},t,n),r.createElement("img",{src:e.src,alt:e.alt,style:t,title:e.isInline&&e.bib?"Author: "+e.bib.author+" @ "+e.bib.licence+(e.bib.edited?", Bearbeitet":""):void 0})},c=function(e){if(e.isInline)return r.createElement(u,e);var t=r.useState(!1),n=(t[0],t[1]),i=r.useState(!1),l=(i[0],i[1],e.caption&&"undefined"!==e.caption),c=e.bib||l;return e.options.noMargins&&!0,r.createElement("figure",{className:s(o,e.options.noMargins&&a),onMouseEnter:function(){return n(!0)},onMouseOut:function(e){var t,r,o,a,i;t=e.currentTarget.getBoundingClientRect(),r=e.clientX,o=e.clientY,a=t.left<=r&&t.right>=r,i=t.top<=o&&t.bottom>=o,a&&i||n(!1)}},r.createElement(u,e),c&&r.createElement("figcaption",null,l&&r.createElement("span",null,e.caption)))}},8218:function(e,t,n){n.r(t),n.d(t,{assets:function(){return d},contentTitle:function(){return u},default:function(){return f},frontMatter:function(){return l},metadata:function(){return c},toc:function(){return p}});var r=n(3117),o=n(102),a=(n(7294),n(3905)),i=n(7921),s=["components"],l={title:"Speedup Build Time on Drone CI",authors:["lebalz"],tags:["drone ci","telegram","node red","bot"],image:"./images/flow.png"},u="A Telegram Bot reporting Drone CI Build states",c={permalink:"/2022/10/12/drone-ci-telegram-bot",editUrl:"https://github.com/lebalz/blog/edit/main/blog/2022-10-12-drone-ci-telegram-bot/index.md",source:"@site/blog/2022-10-12-drone-ci-telegram-bot/index.md",title:"Speedup Build Time on Drone CI",description:"Quickly committing the last change, push and run out the door to the trainstation... Out in the real world, i'm not worried anymore about the build state - i know what i did and for sure i did not made any mistake... \ud83e\udee3",date:"2022-10-12T00:00:00.000Z",formattedDate:"October 12, 2022",tags:[{label:"drone ci",permalink:"/tags/drone-ci"},{label:"telegram",permalink:"/tags/telegram"},{label:"node red",permalink:"/tags/node-red"},{label:"bot",permalink:"/tags/bot"}],readingTime:2.65,hasTruncateMarker:!1,authors:[{name:"Balthasar Hofer",url:"https://github.com/lebalz",imageURL:"https://github.com/lebalz.png",key:"lebalz"}],frontMatter:{title:"Speedup Build Time on Drone CI",authors:["lebalz"],tags:["drone ci","telegram","node red","bot"],image:"./images/flow.png"},nextItem:{title:"Transform Docusaurus Frontmatter",permalink:"/2022/06/09/transform-frontmatter"}},d={image:n(9147).Z,authorsImageUrls:[void 0]},p=[{value:"Requirements",id:"requirements",level:2},{value:"Flow",id:"flow",level:2}],m={toc:p};function f(e){var t=e.components,l=(0,o.Z)(e,s);return(0,a.kt)("wrapper",(0,r.Z)({},m,l,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("p",null,"Quickly committing the last change, push and run out the door to the trainstation... Out in the real world, i'm not worried anymore about the build state - i know what i did and for sure i did not made any mistake... \ud83e\udee3"),(0,a.kt)("p",null,"Yes, mistakes happen and i hate, when a missing comma breaks everything, but i see it not before the next day..."),(0,a.kt)("p",null,"So i wanted a bot telling me the state of the pipeline. But not another email-bot which spams my inbox... Because i'm playing around with node red and telegram is quiet well integrated with it, i decided to use telegram as a notification provider."),(0,a.kt)("h2",{id:"requirements"},"Requirements"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://nodered.org/"},"Node Red")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://flows.nodered.org/node/node-red-contrib-telegrambot"},"node-red-contrib-telegrambot"))),(0,a.kt)("h2",{id:"flow"},"Flow"),(0,a.kt)("div",{style:{display:"flex",justifyContent:"center"}},(0,a.kt)(i.Z,{caption:"undefined",options:{},isInline:!1,src:n(9147).Z,mdxType:"Image"})),(0,a.kt)("p",null,"A ",(0,a.kt)("inlineCode",{parentName:"p"},"http in")," node builds the entry point for the Webhook. A POST Request can then be used from the Drone CI side, to send a POST Request to ",(0,a.kt)("a",{parentName:"p",href:"#"},"/api/drone-ci"),". It's important to acknowledge the request with a ",(0,a.kt)("inlineCode",{parentName:"p"},"200")," Status Code."),(0,a.kt)("p",null,"In your ",(0,a.kt)("inlineCode",{parentName:"p"},".drone.yml")," file add a stage to report the build state:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-yml"},"steps:\n- name: notify\n  image: plugins/webhook\n  settings:\n    urls:\n      from_secret: NODE_RED_WEBHOOK\n")),(0,a.kt)("p",null,"(I added a organization wide ",(0,a.kt)("inlineCode",{parentName:"p"},"NODE_RED_WEBHOOK")," secret with the previously created ",(0,a.kt)("a",{parentName:"p",href:"#"},"/api/drone-ci")," endpoint)"),(0,a.kt)("p",null,"The ",(0,a.kt)("inlineCode",{parentName:"p"},"plugin/webhook")," image sends the needed information about the build state. With this information we have all the things together to send our telegram message."),(0,a.kt)("p",null,"The message content is created with the function node. Be sure to create your Telegram Bot with ",(0,a.kt)("a",{parentName:"p",href:"https://t.me/botfather"},"@Bot Father")," and get your own ",(0,a.kt)("inlineCode",{parentName:"p"},"chatId"),", e.g. from ",(0,a.kt)("a",{parentName:"p",href:"https://telegram.me/rawdatabot"},"@Raw Data Bot"),"."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},"const { owner, name } = msg.payload.repo;\nconst { link, status } = msg.payload.build;\nconst success = status === 'success';\nconst ico = success ? '\u2705' : '\u274c'   ;\nconst repo = `https://github.com/${owner}/${name}`\n\nreturn {\n    payload: {\n        content: `[Build](${link}): ${owner}/${name} ${ico} [Repo](${repo})`,\n        type : 'message',\n        chatId: 123456789,\n        options: {\n            parse_mode : 'Markdown'\n        }\n    }\n}\n")),(0,a.kt)("p",null,":::details Flow Source"),(0,a.kt)("p",null,"Copy&Paste this and your ready to go (except the configuration of your bot...)"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-json"},'[\n    {\n        "id": "f32e663d8a3943a0",\n        "type": "http in",\n        "z": "d5d8db3f081f88c3",\n        "name": "WebHook",\n        "url": "/api/drone-ci",\n        "method": "post",\n        "upload": false,\n        "swaggerDoc": "",\n        "x": 140,\n        "y": 240,\n        "wires": [\n            [\n                "795f65ac4317919d",\n                "20f60dea1c757f9c"\n            ]\n        ]\n    },\n    {\n        "id": "795f65ac4317919d",\n        "type": "http response",\n        "z": "d5d8db3f081f88c3",\n        "name": "Confirm",\n        "statusCode": "200",\n        "headers": {},\n        "x": 300,\n        "y": 200,\n        "wires": []\n    },\n    {\n        "id": "5d155e630c1cea88",\n        "type": "telegram sender",\n        "z": "d5d8db3f081f88c3",\n        "name": "Telegram",\n        "bot": "fcf07fcfe7140093",\n        "haserroroutput": false,\n        "outputs": 1,\n        "x": 460,\n        "y": 240,\n        "wires": [\n            []\n        ]\n    },\n    {\n        "id": "20f60dea1c757f9c",\n        "type": "function",\n        "z": "d5d8db3f081f88c3",\n        "name": "",\n        "func": "const {owner, name} = msg.payload.repo;\\nconst { link, status } = msg.payload.build;\\nconst success = status === \'success\';\\nconst ico = success ? \'\u2705\' : \'\u274c\'   ;\\nconst repo = `https://github.com/${owner}/${name}`\\n\\nreturn {\\n    payload: {\\n      content: `[Build](${link}): ${owner}/${name} ${ico} [Repo](${repo})`,\\n      type : \'message\',\\n      chatId: xxxxxxxxx,\\n        options: {\\n            parse_mode : \'Markdown\'\\n        }\\n    }\\n}",\n        "outputs": 1,\n        "noerr": 0,\n        "initialize": "",\n        "finalize": "",\n        "libs": [],\n        "x": 300,\n        "y": 240,\n        "wires": [\n            [\n                "5d155e630c1cea88"\n            ]\n        ]\n    },\n    {\n        "id": "fcf07fcfe7140093",\n        "type": "telegram bot",\n        "botname": "Drone CI",\n        "usernames": "",\n        "chatids": "",\n        "baseapiurl": "",\n        "updatemode": "polling",\n        "pollinterval": "1000",\n        "usesocks": false,\n        "sockshost": "",\n        "socksport": "6667",\n        "socksusername": "anonymous",\n        "sockspassword": "",\n        "bothost": "",\n        "botpath": "",\n        "localbotport": "8443",\n        "publicbotport": "8443",\n        "privatekey": "",\n        "certificate": "",\n        "useselfsignedcertificate": false,\n        "sslterminated": false,\n        "verboselogging": true\n    }\n]\n')),(0,a.kt)("p",null,":::"))}f.isMDXComponent=!0},9147:function(e,t,n){t.Z=n.p+"assets/images/flow-e6e62cc7efd494aae76345f69ed71951.png"}}]);